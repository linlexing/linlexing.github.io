论基于构件的软件开发方法及其应用
=======================
2024年5月12日
-----------------------
第五次经济普查于2024年进行，经济普查的清查阶段，需要开发一个信息化系统，以支撑200万的普查员采集数据。受国家某部门委托，本人所在公司负责承建经普清查数据处理系统，本人承担架构设计工作。清查数据系统是一个集数据采集、数据审核、数据处理、数据汇总于一体的系统，需要完成各部门原始数据的导入、清理，然后合并生成清查底册；普查员依据清查底册，逐一走访采集清查单位数据，审查员同步进行采集的单位数据审核，最后生成普查底册，供普查系统进行普查。系统的数据处理、采集、审核需求多变，很难事先完全确定，且开发时间短，拟采用构件的方式开发系统，开发构件的容器和数据采集、数据处理、数据审核、数据汇总构件，通过装配完成系统开发和维护。最终系统获取用户一致好评，并成为该行业数据处理系统的一个推荐的架构模型。
基于构件的软件开发过程大致分为，需求分析、构件容器开发、构件开发、构件组装等阶段。需求分析阶段，主要厘清系统的非功能属性需求，针对安全性、可用性、性能、可修改性，划定各构件的职责以及构件容器的具体要求；构件容器开发是依据需求和部署的环境，将各种软硬件资源虚拟化，为构件提供调用资源的API；构件开发是系统开发的主要阶段，构件的功能划分是第一重要工作，应该依据低耦合、高内聚的原则划分构件功能，并依据配置大于编码的原则，编制构件配置参数结构，尽量使得后期维护时，通过参数配置来满足需求变更的要求；构件组装主要由业务开发人员完成，要求开发人员熟悉具体业务，能够通过不同构件的组装满足不同的业务需求。
在清查系统的开发过程中，第一个要解决的就是开发时间问题，项目从23年初启动，看似时间充裕，其实各项工作细则都没有确定，只有五年前四经普的工作流程可以参考，从历次经普工作来看，需求的变化是常态，由于间隔五年，各种工作都是想归想做归做，边做边改。鉴于此，采用构件开发的方式，先依据大致的总体处理流程，开发各种构件，后期的业务开发采用构件装配方式进行，以提高开发速度和适应多变的需求。
从质量属性来看，性能上需要满足全国200万普查员的集中式数据入库，考虑到普查员采用小程序进行数据采集，在小程序端设计离线采集构件，来满足数据查询、数据审核的需求，减轻后端服务器的压力，该构件需要设计精巧的数据同步机制，与后端进行数据同步。
构件是一个程序集，投入使用后，如果需要变更其功能，需要重新修改构件，成本过高，于是设计了构件参数和句柄的概念，即每个构件运行时，把调用构件的参数存贮起来，作为一个调用句柄暴露出去，外部调用时，不能直接调用构件，需要调用具体句柄。这样，使得同一个构件，可以配置不同的参数适应不同的场景，且后期需求变更时，修改参数即可生效。构件的参数存贮、缓存、调用，由构件容器完成，同时容器也提供拦截器机制，方便进行调用日志记录、性能跟踪等附加功能。
从业务流程处理过程来看，可以划分数据导入、数据处理、数据采集、数据审核、数据汇总等构件。其中，数据导入构件，完成各种格式文件数据的导入，由于需要导入各种部门数据，数据项通过配置构件参数来配置。同时，由于每个用户拿到的文件格式和数据项顺序、名称都不相同，构件来接受一个运行时参数，用来映射实际文件中的数据项和参数中预定义的数据项；
数据处理构件，需要完成各种数据清理、合并操作，该构件的配置参数是一个数据处理流程图，由流程节点、端口和边组成，节点通过提炼，有载入、行过滤、列过滤、开始、结束、参数、子流程、循环、分支、合并、转存等各种类型，每个节点依据其功能有固定或变动的输入输出端口，每条边可以连接两个端口，一个端口可以连接任意多的边。构件的运行，就是依据定义的流程，解释执行。多个部门的数据清理、合并，通过该构件和参数配置后，业务开发人员可以专注业务逻辑。
数据采集构件，它的一个配置参数，就是一个采集的表单，包括界面、数据库表结构、前端脚本、后端脚本，相当与一个二次开发平台。其中，数据结构通过版本化的思路，高版本可以应用到低版本数据库上，反之不行。即定义一个数据采集参数后，构件容器初始化时，会检查该构件句柄的配置，自动调整底层数据库的结构。界面采用xml的格式存贮，支持数据绑定，前端脚本运行在浏览器中，后端脚本由数据采集构件解释运行。数据采集构件不仅定义业务表单，也定义各种系统配置表单。
数据审核构件，是一个审核公式执行引擎，由于审核公式数量繁多，而且在系统运行过程中，会不断进行调整，因此，额外设计一个审核公式表单，表单的一条记录就是一个公式，该构件运行时，依据预定义的参数中的审核表单名称，载入审核公式表单中的相应表单的审核公式进行审核，有两种调用方式，一是数据采集构件保存数据时，自动调用该构件完成审核，二是提供一个批量执行审核公式的句柄，由系统调度执行。
数据汇总构件，完成各种格式的汇总表，清查汇总表由主栏宾栏组成，额外设计一个汇总表表单，存贮各汇总表的定义，汇总表的定义由业务开发人员完成。该构件提供汇总界面，用户可以进行多次汇总，每次汇总数据存贮数据库中。
通过以上划分的构件，系统满足用户的需求，在实际的运行阶段，发现系统有性能问题，总是在上午10点半，下午3点半的高峰期，系统宕机。经过长时间的分析，终于定位是某个数据采集操作引起的索引问题，整改后正常。为防止再次出现这种定位困难的情况，在构件容器中添加了拦截器，记录每次调用的开始结束日志，由于日志数量极多，不能直接入库，通过开发一个日志构件，将日志发送该构件存贮，该构件内采用leveldb数据库，存贮到磁盘上，定时批量插入到数据库中，每天定时截取上一天的历史数据到单独的物理表中。再碰到类似的性能问题，通过查询日志表，分析长耗时的调用，可以快速定位问题。
在数据采集进入末期时，审查员开始进行大量的审核操作，造成系统卡顿，经过分析后，发现是某几条审核公式，为了实现名称查重、代码查重，采用了关联查询，而这些公式是重要的质量控制手段，不能删除。经过协商，用户能够接受这些审核公式由系统夜间统一进行，无需保存时实时进行，于是修改数据审核构件，在审核公式的属性中添加了“延迟审核”属性，标有该属性的公式，保存时不审核这些公式，由定时批量审核功能进行审核。
数据汇总构件，由于需要满足该部门特有的包含头格式，即展示其中数的多层表头，但其中一段的边框线不闭合，该构件的配置参数比较复杂，导致用户反馈不好理解。于是通过重新设计参数结构，提升可读性，该过程重复了三次，由于采用构件方式，对其他部分没有影响，同时，某些大数据量的汇总表，汇总一次需要比较长的时间，而用户习惯采用渐进式设计方式，反复调整查看汇总结果，体验不佳。通过分析，用户汇总的数据，基本是已经审核且固定的静态数据，于是依据汇总分组，添加了缓存机制，相同的汇总分组组合，能够直接缓存命中，基本秒出结果，极大提升了用户体验。
一开始，系统的定时审核、定时汇总、定时合并是代码中固定的，后来用户要求，一天进行两次审核，中午一次、晚上一次，同时数据处理也有一些步骤需要依据实际情况调整运行时间，于是开发了后台服务构件，该构件的参数配置了调用的其他构件、调度时间、执行的用户凭据、以及执行的参数，这样，在系统投入使用后，可以实时更改配置，来调配后台任务执行频率。
通过基于构件的开发方式，顺利完成了经普清查数据处理系统的开发，该系统成功完成了清查数据采集和处理工作，获得了用户的好评。同时，该套构件及其构件容器，应用户的要求，投放到另外一个系统中获得使用，为该行业的数据处理系统提供了一个可行的标准架构模型。